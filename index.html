<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>訊息傳送後台</title>
    <style>
        body { background: #000; margin: 0; display: flex; align-items: center; justify-content: center; height: 100vh; overflow: hidden; font-family: -apple-system, sans-serif; }
        
        .phone-frame { position: relative; width: 100vw; height: 100vh; max-width: 450px; max-height: 800px; background: #000; overflow: hidden; }
        #v { position: absolute; width: 100%; height: 100%; object-fit: cover; }
        #drawingCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; pointer-events: none; mix-blend-mode: screen; filter: blur(0.3px) brightness(1.1); }

        /* 後台 UI 區塊 */
        .admin-ui {
            position: absolute; bottom: 30px; width: 100%; z-index: 10;
            display: flex; flex-direction: column; align-items: center; gap: 15px;
            background: linear-gradient(transparent, rgba(0,0,0,0.8)); padding-bottom: 20px;
        }
        
        /* 接收者模式：強制隱藏所有控制項 */
        body.viewer-mode .admin-ui { display: none !important; }

        input { 
            padding: 15px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.3); 
            background: rgba(30,30,30,0.9); color: #fff; text-align: center; width: 85%; 
            font-size: 16px; outline: none; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        
        .btn-row { display: flex; gap: 10px; width: 88%; }
        
        button { 
            flex: 1; padding: 14px; border-radius: 12px; border: none; 
            font-weight: bold; cursor: pointer; font-size: 15px;
            transition: transform 0.1s, opacity 0.2s;
        }
        button:active { transform: scale(0.96); }

        /* 確認鍵：灰色質感 */
        .confirm-btn { background: #E5E5EA; color: #000; }
        /* 分享鍵：經典品牌藍 */
        .share-btn { background: #007AFF; color: #fff; }

        #toast {
            position: fixed; top: 40px; background: #32D74B; color: #fff; 
            padding: 10px 25px; border-radius: 20px; font-weight: bold;
            opacity: 0; transition: opacity 0.3s; z-index: 100; pointer-events: none;
        }
    </style>
</head>
<body class="admin-mode">

    <div id="toast">已複製連結，訊息：<span id="toastMsg"></span></div>

    <div class="phone-frame">
        <video id="v" src="White6.mp4" autoplay loop muted playsinline></video>
        <canvas id="drawingCanvas"></canvas>

        <div class="admin-ui">
            <input type="text" id="userInput" value="你好，我吃一口" placeholder="請輸入訊息...">
            <div class="btn-row">
                <button class="confirm-btn" onclick="updatePreview()">確認預覽</button>
                <button class="share-btn" onclick="shareAndCopy()">分享訊息</button>
            </div>
        </div>
    </div>

<script>
    const v = document.getElementById('v');
    const canvas = document.getElementById('drawingCanvas');
    const ctx = canvas.getContext('2d');
    const inputField = document.getElementById('userInput');
    
    let currentText = "你好，我吃一口";
    let lastPoints = null;

    // --- 1. 模式切換 ---
    const urlParams = new URLSearchParams(window.location.search);
    const sharedMsg = urlParams.get('text');

    if (sharedMsg) {
        currentText = decodeURIComponent(sharedMsg);
        document.body.classList.replace('admin-mode', 'viewer-mode');
        window.onclick = () => { v.muted = false; v.play(); };
    }

    // --- 2. 按鈕邏輯 ---
    function updatePreview() {
        currentText = inputField.value;
        inputField.blur();
    }

    function shareAndCopy() {
        currentText = inputField.value; // 分享時確保抓到最新文字
        const baseUrl = window.location.origin + window.location.pathname;
        const shareUrl = `${baseUrl}?text=${encodeURIComponent(currentText)}`;
        
        navigator.clipboard.writeText(shareUrl).then(() => {
            document.getElementById('toastMsg').innerText = currentText;
            const toast = document.getElementById('toast');
            toast.style.opacity = '1';
            setTimeout(() => toast.style.opacity = '0', 2500);
        });
    }

    // --- 3. 穩定追蹤與平滑算法 ---
    const trackingData = {"3.64":[{"x":"0.1071","y":"0.6915"},{"x":"0.9238","y":"0.6809"},{"x":"0.9238","y":"0.9468"},{"x":"0.1905","y":"0.9839"}],"3.68":[{"x":"0.1619","y":"0.6955"},{"x":"0.8881","y":"0.6809"},{"x":"0.8833","y":"0.9190"},{"x":"0.1881","y":"0.9429"}],"3.71":[{"x":"0.1381","y":"0.6862"},{"x":"0.8548","y":"0.6624"},{"x":"0.8286","y":"0.8833"},{"x":"0.1929","y":"0.9230"}],"3.74":[{"x":"0.1429","y":"0.6770"},{"x":"0.8595","y":"0.6598"},{"x":"0.8500","y":"0.8820"},{"x":"0.1905","y":"0.9257"}],"3.78":[{"x":"0.1452","y":"0.6902"},{"x":"0.8476","y":"0.6585"},{"x":"0.8095","y":"0.8608"},{"x":"0.1881","y":"0.9018"}],"3.81":[{"x":"0.1452","y":"0.6717"},{"x":"0.8190","y":"0.6347"},{"x":"0.7857","y":"0.8423"},{"x":"0.1905","y":"0.8913"}],"3.84":[{"x":"0.1262","y":"0.6823"},{"x":"0.8024","y":"0.6518"},{"x":"0.7857","y":"0.8278"},{"x":"0.1833","y":"0.8820"}],"3.88":[{"x":"0.1667","y":"0.6809"},{"x":"0.8000","y":"0.6267"},{"x":"0.7500","y":"0.7987"},{"x":"0.2167","y":"0.8595"}],"3.91":[{"x":"0.1333","y":"0.6796"},{"x":"0.7976","y":"0.6188"},{"x":"0.7905","y":"0.8079"},{"x":"0.1952","y":"0.8675"}],"3.94":[{"x":"0.2000","y":"0.6664"},{"x":"0.8095","y":"0.6201"},{"x":"0.7762","y":"0.7775"},{"x":"0.2119","y":"0.8595"}],"3.98":[{"x":"0.2024","y":"0.6598"},{"x":"0.8024","y":"0.6148"},{"x":"0.7738","y":"0.7828"},{"x":"0.2071","y":"0.8436"}],"4.01":[{"x":"0.1929","y":"0.6558"},{"x":"0.8119","y":"0.6082"},{"x":"0.7786","y":"0.7722"},{"x":"0.2238","y":"0.8265"}],"4.04":[{"x":"0.2024","y":"0.6452"},{"x":"0.8143","y":"0.6042"},{"x":"0.7976","y":"0.7762"},{"x":"0.2452","y":"0.8198"}],"4.08":[{"x":"0.1952","y":"0.6452"},{"x":"0.8214","y":"0.6042"},{"x":"0.8000","y":"0.7735"},{"x":"0.2381","y":"0.8225"}],"4.11":[{"x":"0.2048","y":"0.6399"},{"x":"0.8310","y":"0.6122"},{"x":"0.8095","y":"0.7868"},{"x":"0.2357","y":"0.8145"}],"4.14":[{"x":"0.2143","y":"0.6320"},{"x":"0.8429","y":"0.6201"},{"x":"0.8405","y":"0.8040"},{"x":"0.2643","y":"0.8093"}],"4.18":[{"x":"0.2262","y":"0.6254"},{"x":"0.8571","y":"0.6227"},{"x":"0.8595","y":"0.8119"},{"x":"0.2667","y":"0.8093"}],"4.21":[{"x":"0.2238","y":"0.6201"},{"x":"0.8619","y":"0.6267"},{"x":"0.9048","y":"0.8331"},{"x":"0.2929","y":"0.8066"}],"4.24":[{"x":"0.2238","y":"0.6201"},{"x":"0.8810","y":"0.6227"},{"x":"0.8714","y":"0.8370"},{"x":"0.2952","y":"0.8106"}],"4.28":[{"x":"0.2333","y":"0.6161"},{"x":"0.8738","y":"0.6307"},{"x":"0.8857","y":"0.8463"},{"x":"0.2952","y":"0.8119"}],"4.31":[{"x":"0.2524","y":"0.6108"},{"x":"0.8714","y":"0.6307"},{"x":"0.9167","y":"0.8714"},{"x":"0.3071","y":"0.8145"}],"4.34":[{"x":"0.2524","y":"0.6095"},{"x":"0.8690","y":"0.6347"},{"x":"0.9119","y":"0.8714"},{"x":"0.3095","y":"0.8172"}],"4.38":[{"x":"0.2429","y":"0.6042"},{"x":"0.8690","y":"0.6294"},{"x":"0.8786","y":"0.8939"},{"x":"0.3095","y":"0.8159"}],"4.41":[{"x":"0.2643","y":"0.6056"},{"x":"0.8738","y":"0.6294"},{"x":"0.8833","y":"0.8860"},{"x":"0.3048","y":"0.8185"}],"4.44":[{"x":"0.2619","y":"0.5936"},{"x":"0.8643","y":"0.6373"},{"x":"0.8881","y":"0.8913"},{"x":"0.3000","y":"0.8198"}],"4.48":[{"x":"0.2357","y":"0.5976"},{"x":"0.8619","y":"0.6320"},{"x":"0.8595","y":"0.9018"},{"x":"0.2714","y":"0.8238"}],"4.51":[{"x":"0.2167","y":"0.5989"},{"x":"0.8548","y":"0.6320"},{"x":"0.8452","y":"0.8913"},{"x":"0.2571","y":"0.8225"}],"4.54":[{"x":"0.2119","y":"0.6016"},{"x":"0.8381","y":"0.6373"},{"x":"0.8310","y":"0.8833"},{"x":"0.2190","y":"0.8185"}],"4.58":[{"x":"0.2071","y":"0.5936"},{"x":"0.8429","y":"0.6333"},{"x":"0.8167","y":"0.8886"},{"x":"0.2095","y":"0.8291"}],"4.61":[{"x":"0.1738","y":"0.5950"},{"x":"0.8429","y":"0.6320"},{"x":"0.8095","y":"0.8926"},{"x":"0.2024","y":"0.8212"}],"4.64":[{"x":"0.1595","y":"0.5989"},{"x":"0.8119","y":"0.6373"},{"x":"0.7881","y":"0.8833"},{"x":"0.1524","y":"0.8265"}],"4.68":[{"x":"0.1667","y":"0.5963"},{"x":"0.8048","y":"0.6373"},{"x":"0.7738","y":"0.8727"},{"x":"0.1548","y":"0.8159"}],"4.71":[{"x":"0.1548","y":"0.6042"},{"x":"0.8000","y":"0.6347"},{"x":"0.7619","y":"0.8595"},{"x":"0.1429","y":"0.8291"}],"4.74":[{"x":"0.1571","y":"0.5989"},{"x":"0.8095","y":"0.6333"},{"x":"0.7714","y":"0.8542"},{"x":"0.1500","y":"0.8251"}],"4.78":[{"x":"0.1429","y":"0.6122"},{"x":"0.8071","y":"0.6294"},{"x":"0.7619","y":"0.8542"},{"x":"0.1333","y":"0.8317"}],"4.81":[{"x":"0.1571","y":"0.6148"},{"x":"0.8095","y":"0.6267"},{"x":"0.7571","y":"0.8317"},{"x":"0.1667","y":"0.8331"}],"4.84":[{"x":"0.1619","y":"0.6201"},{"x":"0.8190","y":"0.6227"},{"x":"0.7810","y":"0.8238"},{"x":"0.1905","y":"0.8317"}],"4.88":[{"x":"0.1786","y":"0.6267"},{"x":"0.8238","y":"0.6214"},{"x":"0.7952","y":"0.8106"},{"x":"0.2167","y":"0.8317"}],"4.91":[{"x":"0.1643","y":"0.6333"},{"x":"0.8190","y":"0.6227"},{"x":"0.8024","y":"0.8185"},{"x":"0.2167","y":"0.8357"}],"4.94":[{"x":"0.1952","y":"0.6360"},{"x":"0.8548","y":"0.6135"},{"x":"0.8286","y":"0.8093"},{"x":"0.2286","y":"0.8463"}],"4.98":[{"x":"0.2262","y":"0.6373"},{"x":"0.8548","y":"0.6122"},{"x":"0.8524","y":"0.8106"},{"x":"0.2810","y":"0.8463"}],"5.01":[{"x":"0.2405","y":"0.6386"},{"x":"0.8690","y":"0.6122"},{"x":"0.8810","y":"0.8106"},{"x":"0.2881","y":"0.8463"}],"5.04":[{"x":"0.2429","y":"0.6545"},{"x":"0.8810","y":"0.6148"},{"x":"0.8810","y":"0.8106"},{"x":"0.3143","y":"0.8436"}],"5.08":[{"x":"0.2500","y":"0.6452"},{"x":"0.9048","y":"0.6069"},{"x":"0.9048","y":"0.8093"},{"x":"0.3095","y":"0.8503"}],"5.11":[{"x":"0.2643","y":"0.6479"},{"x":"0.9048","y":"0.6161"},{"x":"0.9429","y":"0.8212"},{"x":"0.3214","y":"0.8542"}],"5.14":[{"x":"0.2667","y":"0.6545"},{"x":"0.9262","y":"0.6175"},{"x":"0.9643","y":"0.8265"},{"x":"0.3310","y":"0.8582"}],"5.18":[{"x":"0.2762","y":"0.6426"},{"x":"0.9333","y":"0.6227"},{"x":"0.9738","y":"0.8384"},{"x":"0.3262","y":"0.8595"}],"5.21":[{"x":"0.2619","y":"0.6466"},{"x":"0.9381","y":"0.6267"},{"x":"0.9524","y":"0.8542"},{"x":"0.3167","y":"0.8661"}],"5.24":[{"x":"0.2524","y":"0.6505"},{"x":"0.9095","y":"0.6267"},{"x":"0.9524","y":"0.8503"},{"x":"0.3167","y":"0.8582"}],"5.28":[{"x":"0.2619","y":"0.6426"},{"x":"0.9429","y":"0.6280"},{"x":"0.9381","y":"0.8582"},{"x":"0.3190","y":"0.8529"}],"5.31":[{"x":"0.2500","y":"0.6399"},{"x":"0.9167","y":"0.6386"},{"x":"0.9357","y":"0.8780"},{"x":"0.2881","y":"0.8648"}],"5.34":[{"x":"0.2333","y":"0.6399"},{"x":"0.8952","y":"0.6426"},{"x":"0.8881","y":"0.8847"},{"x":"0.2738","y":"0.8595"}],"5.38":[{"x":"0.2214","y":"0.6307"},{"x":"0.8714","y":"0.6518"},{"x":"0.8833","y":"0.8820"},{"x":"0.2357","y":"0.8608"}],"5.41":[{"x":"0.2214","y":"0.6347"},{"x":"0.8643","y":"0.6452"},{"x":"0.8643","y":"0.8860"},{"x":"0.2500","y":"0.8529"}],"5.44":[{"x":"0.2119","y":"0.6333"},{"x":"0.8643","y":"0.6545"},{"x":"0.8429","y":"0.8860"},{"x":"0.2381","y":"0.8516"}],"5.48":[{"x":"0.1952","y":"0.6320"},{"x":"0.8357","y":"0.6638"},{"x":"0.7976","y":"0.8807"},{"x":"0.2167","y":"0.8410"}],"5.51":[{"x":"0.1881","y":"0.6294"},{"x":"0.8286","y":"0.6638"},{"x":"0.8286","y":"0.8873"},{"x":"0.2048","y":"0.8476"}],"5.54":[{"x":"0.1976","y":"0.6294"},{"x":"0.8286","y":"0.6624"},{"x":"0.8071","y":"0.8688"},{"x":"0.1714","y":"0.8503"}],"5.58":[{"x":"0.1881","y":"0.6294"},{"x":"0.8381","y":"0.6611"},{"x":"0.7905","y":"0.8966"},{"x":"0.1643","y":"0.8516"}],"5.61":[{"x":"0.1905","y":"0.6294"},{"x":"0.8310","y":"0.6585"},{"x":"0.7738","y":"0.8780"},{"x":"0.1786","y":"0.8476"}],"5.64":[{"x":"0.1738","y":"0.6320"},{"x":"0.8333","y":"0.6558"},{"x":"0.7857","y":"0.8688"},{"x":"0.1905","y":"0.8476"}],"5.68":[{"x":"0.1786","y":"0.6333"},{"x":"0.8333","y":"0.6492"},{"x":"0.7976","y":"0.8675"},{"x":"0.1881","y":"0.8556"}],"5.71":[{"x":"0.1905","y":"0.6426"},{"x":"0.8595","y":"0.6558"},{"x":"0.8119","y":"0.8635"},{"x":"0.2238","y":"0.8582"}],"5.74":[{"x":"0.1929","y":"0.6413"},{"x":"0.8381","y":"0.6466"},{"x":"0.8214","y":"0.8516"},{"x":"0.2119","y":"0.8476"}],"5.78":[{"x":"0.2095","y":"0.6439"},{"x":"0.8500","y":"0.6479"},{"x":"0.8357","y":"0.8622"},{"x":"0.2238","y":"0.8569"}],"5.81":[{"x":"0.2167","y":"0.6426"},{"x":"0.8643","y":"0.6373"},{"x":"0.8643","y":"0.8595"},{"x":"0.2619","y":"0.8635"}],"5.84":[{"x":"0.2190","y":"0.6558"},{"x":"0.8667","y":"0.6307"},{"x":"0.8643","y":"0.8569"},{"x":"0.2786","y":"0.8701"}],"5.88":[{"x":"0.2500","y":"0.6571"},{"x":"0.8738","y":"0.6373"},{"x":"0.8929","y":"0.8476"},{"x":"0.2833","y":"0.8794"}],"5.91":[{"x":"0.2262","y":"0.6532"},{"x":"0.8905","y":"0.6347"},{"x":"0.8905","y":"0.8489"},{"x":"0.2976","y":"0.8661"}],"5.94":[{"x":"0.2333","y":"0.6638"},{"x":"0.8905","y":"0.6347"},{"x":"0.9286","y":"0.8489"},{"x":"0.2905","y":"0.8661"}],"5.98":[{"x":"0.2452","y":"0.6624"},{"x":"0.8929","y":"0.6320"},{"x":"0.9048","y":"0.8503"},{"x":"0.3024","y":"0.8714"}],"6.01":[{"x":"0.2548","y":"0.6558"},{"x":"0.8952","y":"0.6320"},{"x":"0.9167","y":"0.8556"},{"x":"0.3095","y":"0.8701"}],"6.04":[{"x":"0.2429","y":"0.6651"},{"x":"0.8929","y":"0.6347"},{"x":"0.9000","y":"0.8503"},{"x":"0.2929","y":"0.8741"}]};
    const keys = Object.keys(trackingData).map(Number).sort((a,b)=>a-b);
    function lerp(a, b, t) { return a + (b - a) * t; }

    function getSmoothPoints(currentTime) {
        if (currentTime < keys[0] || currentTime > keys[keys.length-1]) return null;
        let i = 0;
        while (i < keys.length - 2 && keys[i+1] < currentTime) i++;
        const t1 = keys[i], t2 = keys[i+1];
        const p1 = trackingData[t1], p2 = trackingData[t2];
        const ratio = (currentTime - t1) / (t2 - t1);

        let targetPoints = p1.map((pt, idx) => ({
            x: lerp(parseFloat(pt.x), parseFloat(p2[idx].x), ratio),
            y: lerp(parseFloat(pt.y), parseFloat(p2[idx].y), ratio)
        }));

        if (!lastPoints) {
            lastPoints = targetPoints;
        } else {
            const factor = 0.22; // 平滑因子，越小越不抖動
            lastPoints = targetPoints.map((pt, idx) => ({
                x: lastPoints[idx].x + (pt.x - lastPoints[idx].x) * factor,
                y: lastPoints[idx].y + (pt.y - lastPoints[idx].y) * factor
            }));
        }
        return lastPoints;
    }

    function drawSmartChalk(pts, text) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const temp = document.createElement('canvas');
        temp.width = 600; temp.height = 400;
        const tCtx = temp.getContext('2d');
        tCtx.fillStyle = "rgba(255,255,255,0.95)";
        tCtx.textAlign = "center"; tCtx.textBaseline = "middle";
        
        let fontSize = 75;
        let lines = [text];
        if (text.length > 7) {
            fontSize = 50;
            const mid = Math.ceil(text.length / 2);
            lines = [text.substring(0, mid), text.substring(mid)];
        }
        
        tCtx.font = `bold ${fontSize}px "Comic Sans MS", "Marker Felt", "Microsoft JhengHei", sans-serif`;
        lines.forEach((line, i) => {
            const yOffset = (lines.length > 1) ? (i * fontSize * 1.1 - (fontSize/2)) : 0;
            tCtx.fillText(line, 300, 200 + yOffset);
        });

        const p = pts.map(pt => ({ x: pt.x * canvas.width, y: pt.y * canvas.height }));
        const centerX = (p[0].x + p[1].x + p[2].x + p[3].x) / 4;
        const centerY = (p[0].y + p[1].y + p[2].y + p[3].y) / 4;
        const angle = Math.atan2(p[1].y - p[0].y, p[1].x - p[0].x);
        const boardWidth = Math.sqrt(Math.pow(p[1].x - p[0].x, 2) + Math.pow(p[1].y - p[0].y, 2));

        ctx.save();
        ctx.translate(centerX, centerY);
        ctx.rotate(angle);
        const scale = (boardWidth * 0.85) / temp.width;
        ctx.scale(scale, scale);
        ctx.drawImage(temp, -300, -200);
        ctx.restore();
    }

    function animate() {
        const pts = getSmoothPoints(v.currentTime);
        if (pts) drawSmartChalk(pts, currentText);
        else { ctx.clearRect(0,0,canvas.width,canvas.height); lastPoints = null; }
        requestAnimationFrame(animate);
    }

    v.addEventListener('loadedmetadata', () => {
        canvas.width = v.clientWidth;
        canvas.height = v.clientHeight;
        animate();
    });
</script>
</body>
</html>
